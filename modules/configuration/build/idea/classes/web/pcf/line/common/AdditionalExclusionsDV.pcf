<?xml version="1.0"?>
<PCF
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:noNamespaceSchemaLocation="../../../../../../pcf.xsd">
  <DetailViewPanel
    id="AdditionalExclusionsDV">
    <Require
      name="coverable"
      type="Coverable"/>
    <Require
      name="coverageCategories"
      type="String[]"/>
    <Require
      name="includeExclude"
      type="boolean"/>
    <Require
      name="jobWizardHelper"
      type="gw.api.web.job.JobWizardHelper"/>
    <Variable
      initialValue="coverable == null ? {} : filteredExclusions()"
      name="addExclusionsToShow"
      recalculateOnRefresh="true"
      type="gw.api.productmodel.ClausePattern[]"/>
    <InputColumn>
      <InputSet
        visible="addExclusionsToShow.Count &gt; 0">
        <InputIterator
          elementName="pattern"
          forceRefreshDespiteChangedEntries="true"
          id="addedExclIterator"
          value="addExclusionsToShow"
          valueType="gw.api.productmodel.ClausePattern[]">
          <IteratorSort
            sortBy="pattern.CoverageCategory.Priority"
            sortOrder="1"/>
          <IteratorSort
            sortBy="pattern.Priority"
            sortOrder="2"/>
          <InputSetRef
            def="CoverageInputSet( pattern, coverable, CurrentLocation.InEditMode, jobWizardHelper )"
            mode="pattern.PublicID"/>
        </InputIterator>
      </InputSet>
    </InputColumn>
    <Code><![CDATA[uses gw.api.productedition.APDClauseHierarchyHelper
uses gw.api.productmodel.ClausePattern

function filteredExclusions() : ClausePattern[] {
  if (coverable == null) {
    return null
  }

  var exclusions = includeExclude
      ? coverable.getExclusionsInCategories(coverageCategories)
      : coverable.getExclusionsNotInCategories(coverageCategories)

  var clausePatterns = exclusions?.map(\exclusion -> exclusion.Pattern)?.toTypedArray()
  return APDClauseHierarchyHelper.filterTopLevelClauses(coverable, clausePatterns).orderBy(\excl -> excl.Priority).toTypedArray()
}]]></Code>
  </DetailViewPanel>
</PCF>